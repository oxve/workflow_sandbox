name: Label Cherry Pick

on:
  pull_request_target:
    types:
      - labeled
      - closed

jobs:
  prepare_branch_list:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.merge_commit_sha != null
    outputs:
      target_branch: ${{ steps.set-branches.outputs.target_branch }}
    steps:
    - name: Set Branches
      id: set-branches
      env:
        PR_LABELS: ${{ toJson(github.event.pull_request.labels) }}
        EVENT_ACTION: ${{ github.event.action }}
        LABEL_NAME: ${{ github.event.label.name }}
        BASE_REF: ${{ github.base_ref }}
      run: |
        if [[ $EVENT_ACTION == 'closed' ]]; then
          # Get a list of the labels from the PR.
          labels=$(echo "$PR_LABELS" | jq -r '.[].name')
        else
          # Or get the label that was added on the merged PR.
          labels=$LABEL_NAME
        fi

        # This list must contain all cherry-pick destinations as file is used for all branches.
        branches=("main" "26.eap" "26.android" "25.lts.1+" "24.lts.1+" "23.lts.1+" "22.lts.1+" "21.lts.1+" "20.lts.1+" "19.lts.1+" "rc_11" "COBALT_9")
        filtered_branches=()
        for branch in "${branches[@]}"; do
          if [[ $branch == $BASE_REF ]]; then
            continue
          fi
          if [[ ${labels[@]} =~ "cp-$branch" ]]; then
            filtered_branches+=("$branch")
          fi
        done

        echo "target_branch=$(echo -n "${filtered_branches[@]}" | jq -cRs 'split(" ")')" >> $GITHUB_OUTPUT

  cherry_pick:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    needs: prepare_branch_list
    if: needs.prepare_branch_list.outputs.target_branch != '[]'
    strategy:
      matrix:
        target_branch: ${{ fromJson(needs.prepare_branch_list.outputs.target_branch) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        timeout-minutes: 30
        with:
          ref: ${{ matrix.target_branch }}
          fetch-depth: 1
          persist-credentials: false
          filter: blob:none

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Release Automation"
          git config --global user.email "github@google.com"

      - name: Cherry pick merge commit
        id: cherry-pick
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_ACTIONS_API_KEY }}
          MERGE_COMMIT_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TARGET_BRANCH: ${{ matrix.target_branch }}
        run: |
          set -x
          git fetch origin ${TARGET_BRANCH}
          set +e
          # Select the first parent as the mainline tree. This is necessary if
          # the commit has multiple parents as the cherry-pick will fail otherwise.
          git cherry-pick -x --mainline=1 ${MERGE_COMMIT_SHA}
          RES=$?
          set -e
          if [ ${RES} -ne 0 ]; then
            CONFLICTS=$(git diff --name-only --diff-filter=U)
            if [ -n "$CONFLICTS" ]; then
              git add .
              git commit -m "Cherry pick PR #${PR_NUMBER} with conflicts" --no-verify
              python3 .github/scripts/gemini_conflict_resolver.py $CONFLICTS
              git add .
              if [ -z "$(git diff --name-only --diff-filter=U)" ]; then
                git commit -m "Resolve cherry-pick conflicts for PR #${PR_NUMBER} using Gemini"
              else
                git commit -m "Partially resolved conflicts for PR #${PR_NUMBER} using Gemini" --no-verify
              fi
            fi
          fi
          exit ${RES}

      - name: Create Pull Request
        id: create-pr
        continue-on-error: true
        uses: peter-evans/create-pull-request@2b011faafdcbc9ceb11414d64d0573f37c774b04 # v4.2.3
        with:
          token: ${{ secrets.CHERRY_PICK_TOKEN }}
          draft: ${{ steps.cherry-pick.outcome == 'failure' }}
          base: ${{ matrix.target_branch }}
          branch: cherry-pick-${{ matrix.target_branch }}-${{ github.event.pull_request.number }}
          committer: GitHub Release Automation <github@google.com>
          reviewers: |
            ${{ github.event.pull_request.user.login }}
            ${{ github.actor }}
          title: "Cherry pick PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          body: |
            Refer to the original PR: https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}

            ${{ github.event.pull_request.body }}

      - name: Comment on failure
        uses: actions/github-script@v8
        env:
          REPOSITORY: ${{ github.repository }}
          NEW_PR_NUMBER: ${{ steps.create-pr.outputs.pull-request-number }}
          CHERRY_PICK_OUTCOME: ${{ steps.cherry-pick.outcome }}
        with:
          github-token: ${{ secrets.CHERRY_PICK_TOKEN }}
          script: |
            const { NEW_PR_NUMBER, CHERRY_PICK_OUTCOME, REPOSITORY, CHERRY_PICK_BRANCH } = process.env;
            if (NEW_PR_NUMBER == '') {
              // Comment on the originating PR if creating a cherry pick PR failed.
              github.rest.issues.createComment({
                issue_number: context.payload.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `> [!CAUTION]\n> Creating the cherry pick PR failed! Check the log at ${context.serverUrl}/${REPOSITORY}/actions/runs/${context.runId} for details.`
              });
            } else if (CHERRY_PICK_OUTCOME == 'failure') {
              // Comment on the new PR if the cherry pick failed.
              const cautionHeader = '[!CAUTION]\n> There were merge conflicts while cherry picking! Gemini has attempted to fix the conflicts so please review carefully before merging.';
              const checkoutInstructions = 'To checkout the branch, run:\n```\ngit fetch origin ${CHERRY_PICK_BRANCH}; git checkout FETCH_HEAD\n```';
              const logFooter = 'Check the log at ${context.serverUrl}/${REPOSITORY}/actions/runs/${context.runId} for details.';
              github.rest.issues.createComment({
                issue_number: parseInt(NEW_PR_NUMBER),
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `![MERGE CONFLICT CAT](https://services.google.com/fh/files/misc/merge_conflict_cat.png)\n> ${cautionHeader}n\${checkoutInstructions}\n\n{logFooter}`
              });
            }
